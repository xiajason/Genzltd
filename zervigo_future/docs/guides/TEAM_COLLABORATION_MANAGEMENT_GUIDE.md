# JobFirst å›¢é˜Ÿåä½œå¼€å‘ç®¡ç†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨è…¾è®¯äº‘è½»é‡åº”ç”¨æœåŠ¡å™¨ä¸Šå®ç°å®‰å…¨çš„å›¢é˜Ÿåä½œå¼€å‘ï¼ŒåŒ…æ‹¬ç”¨æˆ·è´¦å·ç®¡ç†ã€æƒé™æ§åˆ¶ã€å®‰å…¨ç­–ç•¥ç­‰ã€‚

## ğŸ¯ ç®¡ç†ç›®æ ‡

- **å®‰å…¨æ€§**ï¼šç¡®ä¿æœåŠ¡å™¨å’Œä»£ç å®‰å…¨
- **å¯æ§æ€§**ï¼šç²¾ç¡®æ§åˆ¶æ¯ä¸ªæˆå‘˜çš„è®¿é—®æƒé™
- **å¯è¿½æº¯æ€§**ï¼šè®°å½•æ‰€æœ‰æ“ä½œæ—¥å¿—
- **é«˜æ•ˆæ€§**ï¼šæ”¯æŒå¤šäººåŒæ—¶åä½œå¼€å‘

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. ç”¨æˆ·è§’è‰²ä½“ç³»

```
è¶…çº§ç®¡ç†å‘˜ (Super Admin)
â”œâ”€â”€ ç³»ç»Ÿç®¡ç†å‘˜ (System Admin)
â”œâ”€â”€ å¼€å‘è´Ÿè´£äºº (Dev Lead)
â”œâ”€â”€ å‰ç«¯å¼€å‘ (Frontend Dev)
â”œâ”€â”€ åç«¯å¼€å‘ (Backend Dev)
â”œâ”€â”€ æµ‹è¯•å·¥ç¨‹å¸ˆ (QA Engineer)
â””â”€â”€ è®¿å®¢ç”¨æˆ· (Guest)
```

### 2. æƒé™çŸ©é˜µ

| è§’è‰² | æœåŠ¡å™¨è®¿é—® | ä»£ç ä¿®æ”¹ | æ•°æ®åº“æ“ä½œ | æœåŠ¡é‡å¯ | é…ç½®ä¿®æ”¹ | æ—¥å¿—æŸ¥çœ‹ |
|------|------------|----------|------------|----------|----------|----------|
| è¶…çº§ç®¡ç†å‘˜ | âœ… å®Œå…¨è®¿é—® | âœ… æ‰€æœ‰æ¨¡å— | âœ… æ‰€æœ‰æ•°æ®åº“ | âœ… æ‰€æœ‰æœåŠ¡ | âœ… æ‰€æœ‰é…ç½® | âœ… æ‰€æœ‰æ—¥å¿— |
| ç³»ç»Ÿç®¡ç†å‘˜ | âœ… å®Œå…¨è®¿é—® | âœ… æ‰€æœ‰æ¨¡å— | âœ… æ‰€æœ‰æ•°æ®åº“ | âœ… æ‰€æœ‰æœåŠ¡ | âœ… ç³»ç»Ÿé…ç½® | âœ… æ‰€æœ‰æ—¥å¿— |
| å¼€å‘è´Ÿè´£äºº | âœ… å®Œå…¨è®¿é—® | âœ… æ‰€æœ‰æ¨¡å— | âœ… ä¸šåŠ¡æ•°æ®åº“ | âœ… ä¸šåŠ¡æœåŠ¡ | âœ… ä¸šåŠ¡é…ç½® | âœ… ä¸šåŠ¡æ—¥å¿— |
| å‰ç«¯å¼€å‘ | âœ… SSHè®¿é—® | âœ… å‰ç«¯ä»£ç  | âŒ æ•°æ®åº“ | âŒ æœåŠ¡é‡å¯ | âœ… å‰ç«¯é…ç½® | âœ… å‰ç«¯æ—¥å¿— |
| åç«¯å¼€å‘ | âœ… SSHè®¿é—® | âœ… åç«¯ä»£ç  | âœ… ä¸šåŠ¡æ•°æ®åº“ | âœ… ä¸šåŠ¡æœåŠ¡ | âœ… åç«¯é…ç½® | âœ… åç«¯æ—¥å¿— |
| æµ‹è¯•å·¥ç¨‹å¸ˆ | âœ… SSHè®¿é—® | âœ… æµ‹è¯•ä»£ç  | âœ… æµ‹è¯•æ•°æ®åº“ | âœ… æµ‹è¯•æœåŠ¡ | âœ… æµ‹è¯•é…ç½® | âœ… æµ‹è¯•æ—¥å¿— |
| è®¿å®¢ç”¨æˆ· | âŒ æ— è®¿é—® | âŒ æ— æƒé™ | âŒ æ— æƒé™ | âŒ æ— æƒé™ | âŒ æ— æƒé™ | âŒ æ— æƒé™ |

## ğŸ”§ å®æ–½æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šè…¾è®¯äº‘CAM + SSHå¯†é’¥ç®¡ç†ï¼ˆæ¨èï¼‰

#### 1. è…¾è®¯äº‘CAMé…ç½®

**æ­¥éª¤1ï¼šåˆ›å»ºå­è´¦å·**
```bash
# åœ¨è…¾è®¯äº‘æ§åˆ¶å°åˆ›å»ºå­è´¦å·
# è®¿é—®ï¼šhttps://console.cloud.tencent.com/cam
# ä¸ºæ¯ä¸ªå›¢é˜Ÿæˆå‘˜åˆ›å»ºç‹¬ç«‹å­è´¦å·
```

**æ­¥éª¤2ï¼šé…ç½®æƒé™ç­–ç•¥**
```json
{
    "version": "2.0",
    "statement": [
        {
            "effect": "allow",
            "action": [
                "lighthouse:DescribeInstances",
                "lighthouse:DescribeInstanceLoginKeyPair",
                "lighthouse:CreateInstanceLoginKeyPair"
            ],
            "resource": "qcs::lighthouse:*:*:instance/jobfirst-*"
        }
    ]
}
```

#### 2. SSHç”¨æˆ·ç®¡ç†

**åˆ›å»ºç”¨æˆ·ç®¡ç†è„šæœ¬**
```bash
#!/bin/bash
# ç”¨æˆ·ç®¡ç†è„šæœ¬

# æ·»åŠ å¼€å‘ç”¨æˆ·
add_dev_user() {
    local username=$1
    local role=$2
    local ssh_key=$3
    
    # åˆ›å»ºç”¨æˆ·
    useradd -m -s /bin/bash $username
    
    # è®¾ç½®ç”¨æˆ·ç»„
    usermod -aG developers $username
    
    # é…ç½®SSHå¯†é’¥
    mkdir -p /home/$username/.ssh
    echo "$ssh_key" > /home/$username/.ssh/authorized_keys
    chmod 700 /home/$username/.ssh
    chmod 600 /home/$username/.ssh/authorized_keys
    chown -R $username:$username /home/$username/.ssh
    
    # è®¾ç½®sudoæƒé™
    case $role in
        "admin")
            echo "$username ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/dev-users
            ;;
        "developer")
            echo "$username ALL=(ALL) NOPASSWD:/opt/jobfirst/scripts/restart-services.sh,/opt/jobfirst/scripts/deploy.sh" >> /etc/sudoers.d/dev-users
            ;;
        "frontend")
            echo "$username ALL=(ALL) NOPASSWD:/opt/jobfirst/scripts/restart-frontend.sh" >> /etc/sudoers.d/dev-users
            ;;
    esac
    
    echo "ç”¨æˆ· $username åˆ›å»ºæˆåŠŸï¼Œè§’è‰²ï¼š$role"
}
```

### æ–¹æ¡ˆäºŒï¼šåŸºäºJobFirstç³»ç»Ÿçš„ç”¨æˆ·ç®¡ç†

#### 1. æ‰©å±•ç”¨æˆ·è¡¨ç»“æ„

```sql
-- å¼€å‘å›¢é˜Ÿç”¨æˆ·è¡¨
CREATE TABLE IF NOT EXISTS dev_team_users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    team_role ENUM('super_admin', 'system_admin', 'dev_lead', 'frontend_dev', 'backend_dev', 'qa_engineer', 'guest') NOT NULL,
    ssh_public_key TEXT,
    server_access_level ENUM('full', 'limited', 'readonly', 'none') DEFAULT 'limited',
    code_access_modules JSON, -- å¯è®¿é—®çš„ä»£ç æ¨¡å—
    database_access JSON, -- å¯è®¿é—®çš„æ•°æ®åº“
    service_restart_permissions JSON, -- å¯é‡å¯çš„æœåŠ¡
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_team_role (team_role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE IF NOT EXISTS dev_operation_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    operation_type VARCHAR(100) NOT NULL,
    operation_target VARCHAR(255),
    operation_details JSON,
    ip_address VARCHAR(45),
    user_agent TEXT,
    status ENUM('success', 'failed', 'blocked') DEFAULT 'success',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_operation_type (operation_type),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 2. æƒé™æ§åˆ¶ä¸­é—´ä»¶

```go
// å¼€å‘å›¢é˜Ÿæƒé™ä¸­é—´ä»¶
func DevTeamAuthMiddleware(requiredRole string, requiredPermissions []string) gin.HandlerFunc {
    return func(c *gin.Context) {
        // è·å–ç”¨æˆ·ä¿¡æ¯
        userID := c.GetInt("user_id")
        
        // æŸ¥è¯¢å¼€å‘å›¢é˜Ÿæƒé™
        var devUser DevTeamUser
        if err := db.Where("user_id = ?", userID).First(&devUser).Error; err != nil {
            c.JSON(http.StatusForbidden, gin.H{"error": "Not a team member"})
            c.Abort()
            return
        }
        
        // æ£€æŸ¥è§’è‰²æƒé™
        if !hasRolePermission(devUser.TeamRole, requiredRole) {
            c.JSON(http.StatusForbidden, gin.H{"error": "Insufficient role"})
            c.Abort()
            return
        }
        
        // æ£€æŸ¥å…·ä½“æƒé™
        for _, permission := range requiredPermissions {
            if !hasPermission(devUser, permission) {
                c.JSON(http.StatusForbidden, gin.H{"error": "Insufficient permissions"})
                c.Abort()
                return
            }
        }
        
        // è®°å½•æ“ä½œæ—¥å¿—
        logOperation(userID, c.Request.Method, c.Request.URL.Path, c.ClientIP())
        
        c.Set("dev_user", devUser)
        c.Next()
    }
}
```

## ğŸ›¡ï¸ å®‰å…¨ç­–ç•¥

### 1. SSHå®‰å…¨é…ç½®

```bash
# /etc/ssh/sshd_config
Port 22
Protocol 2
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2
AllowUsers dev_user1 dev_user2 dev_user3
DenyUsers guest
```

### 2. é˜²ç«å¢™é…ç½®

```bash
# åªå…è®¸ç‰¹å®šIPè®¿é—®
ufw allow from 192.168.1.0/24 to any port 22
ufw allow from 10.0.0.0/8 to any port 22
ufw deny 22
```

### 3. æ“ä½œå®¡è®¡

```bash
# å¯ç”¨auditd
systemctl enable auditd
systemctl start auditd

# ç›‘æ§å…³é”®æ“ä½œ
auditctl -w /opt/jobfirst/ -p rwxa -k jobfirst_access
auditctl -w /etc/nginx/ -p rwxa -k nginx_config
auditctl -w /etc/mysql/ -p rwxa -k mysql_config
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. å®æ—¶ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# å›¢é˜Ÿåä½œç›‘æ§è„šæœ¬

echo "=== å›¢é˜Ÿåä½œç›‘æ§ ==="
echo "æ—¶é—´: $(date)"
echo

# å½“å‰ç™»å½•ç”¨æˆ·
echo "1. å½“å‰ç™»å½•ç”¨æˆ·:"
who
echo

# SSHè¿æ¥çŠ¶æ€
echo "2. SSHè¿æ¥çŠ¶æ€:"
ss -tuln | grep :22
echo

# ç³»ç»Ÿèµ„æºä½¿ç”¨
echo "3. ç³»ç»Ÿèµ„æºä½¿ç”¨:"
top -bn1 | head -5
echo

# æœ€è¿‘æ“ä½œæ—¥å¿—
echo "4. æœ€è¿‘æ“ä½œæ—¥å¿—:"
tail -10 /var/log/auth.log | grep ssh
echo

# é¡¹ç›®æ–‡ä»¶ä¿®æ”¹è®°å½•
echo "5. é¡¹ç›®æ–‡ä»¶ä¿®æ”¹è®°å½•:"
find /opt/jobfirst -type f -mtime -1 -ls | head -10
echo
```

### 2. æ“ä½œæ—¥å¿—è®°å½•

```go
// æ“ä½œæ—¥å¿—è®°å½•å‡½æ•°
func logOperation(userID int, method, path, ip string) {
    log := DevOperationLog{
        UserID:          userID,
        OperationType:   method,
        OperationTarget: path,
        IPAddress:       ip,
        UserAgent:       c.GetHeader("User-Agent"),
        Status:          "success",
    }
    
    db.Create(&log)
}
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# åˆ›å»ºå¼€å‘ç”¨æˆ·ç»„
groupadd developers

# åˆ›å»ºsudoersé…ç½®ç›®å½•
mkdir -p /etc/sudoers.d
```

### 2. ç”¨æˆ·åˆ›å»º

```bash
# ä¸ºæ¯ä¸ªå›¢é˜Ÿæˆå‘˜åˆ›å»ºè´¦å·
./scripts/create-dev-user.sh frontend_dev1 "frontend" "ssh-rsa AAAAB3NzaC1yc2E..."
./scripts/create-dev-user.sh backend_dev1 "backend" "ssh-rsa AAAAB3NzaC1yc2E..."
./scripts/create-dev-user.sh qa_engineer1 "qa" "ssh-rsa AAAAB3NzaC1yc2E..."
```

### 3. æƒé™é…ç½®

```bash
# é…ç½®é¡¹ç›®ç›®å½•æƒé™
chown -R root:developers /opt/jobfirst
chmod -R 775 /opt/jobfirst

# é…ç½®æ—¥å¿—ç›®å½•æƒé™
chown -R root:developers /opt/jobfirst/logs
chmod -R 755 /opt/jobfirst/logs
```

## ğŸ“‹ ç®¡ç†å·¥å…·

### 1. ç”¨æˆ·ç®¡ç†ç•Œé¢

```typescript
// å¼€å‘å›¢é˜Ÿç®¡ç†é¡µé¢
interface DevTeamUser {
  id: number;
  username: string;
  email: string;
  teamRole: 'super_admin' | 'system_admin' | 'dev_lead' | 'frontend_dev' | 'backend_dev' | 'qa_engineer' | 'guest';
  serverAccessLevel: 'full' | 'limited' | 'readonly' | 'none';
  codeAccessModules: string[];
  databaseAccess: string[];
  serviceRestartPermissions: string[];
  lastLoginAt: string;
  status: 'active' | 'inactive' | 'suspended';
}
```

### 2. æƒé™ç®¡ç†API

```go
// å¼€å‘å›¢é˜Ÿç®¡ç†API
type DevTeamController struct {
    db *gorm.DB
}

// è·å–å›¢é˜Ÿæˆå‘˜åˆ—è¡¨
func (dtc *DevTeamController) GetTeamMembers(c *gin.Context) {
    // å®ç°è·å–å›¢é˜Ÿæˆå‘˜åˆ—è¡¨
}

// æ·»åŠ å›¢é˜Ÿæˆå‘˜
func (dtc *DevTeamController) AddTeamMember(c *gin.Context) {
    // å®ç°æ·»åŠ å›¢é˜Ÿæˆå‘˜
}

// æ›´æ–°æˆå‘˜æƒé™
func (dtc *DevTeamController) UpdateMemberPermissions(c *gin.Context) {
    // å®ç°æ›´æ–°æˆå‘˜æƒé™
}

// è·å–æ“ä½œæ—¥å¿—
func (dtc *DevTeamController) GetOperationLogs(c *gin.Context) {
    // å®ç°è·å–æ“ä½œæ—¥å¿—
}
```

## ğŸ” æœ€ä½³å®è·µ

### 1. å®‰å…¨æœ€ä½³å®è·µ

- **æœ€å°æƒé™åŸåˆ™**ï¼šåªæˆäºˆå¿…è¦çš„æƒé™
- **å®šæœŸæƒé™å®¡æŸ¥**ï¼šæ¯æœˆå®¡æŸ¥ä¸€æ¬¡æƒé™é…ç½®
- **å¼ºå¯†ç ç­–ç•¥**ï¼šè¦æ±‚å¤æ‚å¯†ç å’Œå®šæœŸæ›´æ¢
- **åŒå› ç´ è®¤è¯**ï¼šå¯¹ç®¡ç†å‘˜è´¦å·å¯ç”¨2FA
- **æ“ä½œå®¡è®¡**ï¼šè®°å½•æ‰€æœ‰å…³é”®æ“ä½œ

### 2. åä½œæœ€ä½³å®è·µ

- **ä»£ç å®¡æŸ¥**ï¼šæ‰€æœ‰ä»£ç ä¿®æ”¹éƒ½éœ€è¦å®¡æŸ¥
- **åˆ†æ”¯ç®¡ç†**ï¼šä½¿ç”¨Gitåˆ†æ”¯è¿›è¡ŒåŠŸèƒ½å¼€å‘
- **ç¯å¢ƒéš”ç¦»**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒåˆ†ç¦»
- **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°æŠ€æœ¯æ–‡æ¡£
- **å®šæœŸåŒæ­¥**ï¼šå®šæœŸåŒæ­¥ä»£ç å’Œé…ç½®

### 3. ç›‘æ§æœ€ä½³å®è·µ

- **å®æ—¶ç›‘æ§**ï¼šç›‘æ§ç³»ç»ŸçŠ¶æ€å’Œç”¨æˆ·æ´»åŠ¨
- **å¼‚å¸¸å‘Šè­¦**ï¼šè®¾ç½®å¼‚å¸¸æ“ä½œå‘Šè­¦
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
- **æ—¥å¿—åˆ†æ**ï¼šå®šæœŸåˆ†ææ“ä½œæ—¥å¿—
- **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½é‡è¦æ•°æ®

## ğŸ“ æ”¯æŒè”ç³»

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- ç³»ç»Ÿç®¡ç†å‘˜ï¼šadmin@jobfirst.com
- æŠ€æœ¯æ”¯æŒï¼šsupport@jobfirst.com
- ç´§æ€¥è”ç³»ï¼š+86-xxx-xxxx-xxxx

---

**æ³¨æ„**ï¼šæœ¬æŒ‡å—åŸºäºJobFirstç³»ç»Ÿçš„å®é™…éœ€æ±‚è®¾è®¡ï¼Œè¯·æ ¹æ®å›¢é˜Ÿå…·ä½“æƒ…å†µè°ƒæ•´é…ç½®ã€‚
