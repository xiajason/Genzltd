# å¾®æœåŠ¡è®¤è¯ç»Ÿä¸€è®¡åˆ’

## ğŸ¯ ç›®æ ‡

ç»Ÿä¸€å¾®æœåŠ¡ä¹‹é—´çš„è®¤è¯æœºåˆ¶ï¼Œä¿æŒbasic-serverç‹¬ç«‹ï¼Œä¸“æ³¨äºå¾®æœåŠ¡é›†ç¾¤çš„è®¤è¯ä¸€è‡´æ€§ã€‚

## ğŸ“‹ å½“å‰æ¶æ„åˆ†æ

### ç°æœ‰æœåŠ¡åˆ†ç±»
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JobFirst ç³»ç»Ÿæ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   basic-server  â”‚    â”‚        å¾®æœåŠ¡é›†ç¾¤                â”‚ â”‚
â”‚  â”‚   (å•ä½“åº”ç”¨)     â”‚    â”‚                                 â”‚ â”‚
â”‚  â”‚                 â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  - ç‹¬ç«‹è®¤è¯      â”‚    â”‚  â”‚user-svc â”‚  â”‚job-svc  â”‚      â”‚ â”‚
â”‚  â”‚  - ç‹¬ç«‹è·¯ç”±      â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â”‚  - ç‹¬ç«‹ä¸šåŠ¡é€»è¾‘  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚resume-  â”‚  â”‚company- â”‚      â”‚ â”‚
â”‚                         â”‚  â”‚svc      â”‚  â”‚svc      â”‚      â”‚ â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚                         â”‚  â”‚template â”‚  â”‚banner-  â”‚      â”‚ â”‚
â”‚                         â”‚  â”‚svc      â”‚  â”‚svc      â”‚      â”‚ â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚                         â”‚  â”‚stats-   â”‚  â”‚dev-team â”‚      â”‚ â”‚
â”‚                         â”‚  â”‚svc      â”‚  â”‚svc      â”‚      â”‚ â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚                         â”‚  â”‚notify-  â”‚  â”‚multi-db â”‚      â”‚ â”‚
â”‚                         â”‚  â”‚svc      â”‚  â”‚svc      â”‚      â”‚ â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚                         â”‚                                 â”‚ â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚                         â”‚  â”‚    ç»Ÿä¸€è®¤è¯æœåŠ¡              â”‚ â”‚ â”‚
â”‚                         â”‚  â”‚  (unified-auth-service)     â”‚ â”‚ â”‚
â”‚                         â”‚  â”‚                             â”‚ â”‚ â”‚
â”‚                         â”‚  â”‚  - JWT éªŒè¯                 â”‚ â”‚ â”‚
â”‚                         â”‚  â”‚  - è§’è‰²ç®¡ç†                 â”‚ â”‚ â”‚
â”‚                         â”‚  â”‚  - æƒé™æ§åˆ¶                 â”‚ â”‚ â”‚
â”‚                         â”‚  â”‚  - ç”¨æˆ·ç®¡ç†                 â”‚ â”‚ â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ç»Ÿä¸€ç­–ç•¥

### åŸåˆ™
1. **ä¿æŒbasic-serverç‹¬ç«‹** - ä¸ä¿®æ”¹basic-serverçš„ä»»ä½•ä»£ç 
2. **ç»Ÿä¸€å¾®æœåŠ¡è®¤è¯** - æ‰€æœ‰å¾®æœåŠ¡ä½¿ç”¨ç›¸åŒçš„è®¤è¯æœºåˆ¶
3. **æ¸è¿›å¼å®æ–½** - åˆ†é˜¶æ®µå®æ–½ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§
4. **å‘åå…¼å®¹** - ä¿æŒç°æœ‰APIçš„å…¼å®¹æ€§

### å®æ–½è®¡åˆ’

#### ç¬¬ä¸€é˜¶æ®µï¼šè®¤è¯ä¸­é—´ä»¶ç»Ÿä¸€
**ç›®æ ‡**ï¼šç»Ÿä¸€æ‰€æœ‰å¾®æœåŠ¡çš„è®¤è¯ä¸­é—´ä»¶

**å…·ä½“ä»»åŠ¡**ï¼š
1. **åˆ›å»ºç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶**
   ```go
   // ä½ç½®ï¼šbasic/backend/pkg/middleware/unified_auth.go
   package middleware
   
   type UnifiedAuthMiddleware struct {
       authServiceURL string
       jwtSecret      string
   }
   
   func (m *UnifiedAuthMiddleware) ValidateToken(token string) (*UserInfo, error)
   func (m *UnifiedAuthMiddleware) CheckPermission(userID uint, resource string, action string) (bool, error)
   ```

2. **ç»Ÿä¸€JWTæ ¼å¼**
   ```go
   type UnifiedJWTClaims struct {
       UserID   uint     `json:"user_id"`
       Username string   `json:"username"`
       Role     string   `json:"role"`
       Permissions []string `json:"permissions"`
       Exp      int64    `json:"exp"`
       Iat      int64    `json:"iat"`
       jwt.RegisteredClaims
   }
   ```

3. **æ›´æ–°æ‰€æœ‰å¾®æœåŠ¡**
   - user-service
   - job-service
   - resume-service
   - company-service
   - template-service
   - banner-service
   - statistics-service
   - dev-team-service
   - notification-service
   - multi-database-service

#### ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®æ¨¡å‹ç»Ÿä¸€
**ç›®æ ‡**ï¼šç»Ÿä¸€ç”¨æˆ·ã€è§’è‰²ã€æƒé™çš„æ•°æ®æ¨¡å‹

**å…·ä½“ä»»åŠ¡**ï¼š
1. **ç»Ÿä¸€ç”¨æˆ·æ¨¡å‹**
   ```go
   type UnifiedUser struct {
       ID           uint      `json:"id"`
       Username     string    `json:"username"`
       Email        string    `json:"email"`
       Role         string    `json:"role"`
       Permissions  []string  `json:"permissions"`
       Status       string    `json:"status"`
       CreatedAt    time.Time `json:"created_at"`
       UpdatedAt    time.Time `json:"updated_at"`
   }
   ```

2. **ç»Ÿä¸€è§’è‰²å®šä¹‰**
   ```go
   const (
       RoleGuest      = "guest"
       RoleUser       = "user"
       RoleVip        = "vip"
       RoleModerator  = "moderator"
       RoleAdmin      = "admin"
       RoleSuperAdmin = "super_admin"
   )
   ```

3. **ç»Ÿä¸€æƒé™å®šä¹‰**
   ```go
   const (
       PermissionRead   = "read"
       PermissionWrite  = "write"
       PermissionDelete = "delete"
       PermissionAdmin  = "admin"
   )
   ```

#### ç¬¬ä¸‰é˜¶æ®µï¼šAPIæ¥å£ç»Ÿä¸€
**ç›®æ ‡**ï¼šç»Ÿä¸€è®¤è¯ç›¸å…³çš„APIæ¥å£

**å…·ä½“ä»»åŠ¡**ï¼š
1. **ç»Ÿä¸€è®¤è¯API**
   - `/api/v1/auth/login`
   - `/api/v1/auth/logout`
   - `/api/v1/auth/validate`
   - `/api/v1/auth/refresh`

2. **ç»Ÿä¸€ç”¨æˆ·ç®¡ç†API**
   - `/api/v1/users/profile`
   - `/api/v1/users/permissions`
   - `/api/v1/users/roles`

3. **ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼**
   ```go
   type UnifiedErrorResponse struct {
       Success   bool   `json:"success"`
       Error     string `json:"error"`
       Code      string `json:"code"`
       Message   string `json:"message"`
       Timestamp string `json:"timestamp"`
   }
   ```

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### 1. ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶
```go
// basic/backend/pkg/middleware/unified_auth.go
package middleware

import (
    "context"
    "net/http"
    "strings"
    
    "github.com/gin-gonic/gin"
    "github.com/golang-jwt/jwt/v5"
)

type UnifiedAuthMiddleware struct {
    authServiceURL string
    jwtSecret      string
}

func NewUnifiedAuthMiddleware(authServiceURL, jwtSecret string) *UnifiedAuthMiddleware {
    return &UnifiedAuthMiddleware{
        authServiceURL: authServiceURL,
        jwtSecret:      jwtSecret,
    }
}

func (m *UnifiedAuthMiddleware) AuthRequired() gin.HandlerFunc {
    return func(c *gin.Context) {
        token := m.extractToken(c)
        if token == "" {
            c.JSON(http.StatusUnauthorized, gin.H{
                "success": false,
                "error":   "Token required",
                "code":    "TOKEN_REQUIRED",
            })
            c.Abort()
            return
        }

        userInfo, err := m.validateToken(token)
        if err != nil {
            c.JSON(http.StatusUnauthorized, gin.H{
                "success": false,
                "error":   "Invalid token",
                "code":    "INVALID_TOKEN",
            })
            c.Abort()
            return
        }

        c.Set("user", userInfo)
        c.Next()
    }
}

func (m *UnifiedAuthMiddleware) extractToken(c *gin.Context) string {
    authHeader := c.GetHeader("Authorization")
    if authHeader == "" {
        return ""
    }
    
    parts := strings.Split(authHeader, " ")
    if len(parts) != 2 || parts[0] != "Bearer" {
        return ""
    }
    
    return parts[1]
}

func (m *UnifiedAuthMiddleware) validateToken(tokenString string) (*UnifiedUser, error) {
    // å®ç°JWTéªŒè¯é€»è¾‘
    // å¯ä»¥è°ƒç”¨unified-auth-serviceè¿›è¡ŒéªŒè¯
    // æˆ–è€…ç›´æ¥éªŒè¯JWTç­¾å
}
```

### 2. å¾®æœåŠ¡é›†æˆç¤ºä¾‹
```go
// basic/backend/internal/user/main.go
package main

import (
    "github.com/gin-gonic/gin"
    "github.com/xiajason/zervi-basic/basic/backend/pkg/middleware"
)

func main() {
    r := gin.Default()
    
    // åˆå§‹åŒ–ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶
    authMiddleware := middleware.NewUnifiedAuthMiddleware(
        "http://localhost:8207",
        "jobfirst-unified-auth-secret-key-2024",
    )
    
    // åº”ç”¨è®¤è¯ä¸­é—´ä»¶
    api := r.Group("/api/v1")
    api.Use(authMiddleware.AuthRequired())
    
    // ä¸šåŠ¡è·¯ç”±
    api.GET("/users/profile", getUserProfile)
    api.PUT("/users/profile", updateUserProfile)
    
    r.Run(":8081")
}
```

## ğŸ“Š å®æ–½æ—¶é—´è¡¨

### ç¬¬1å‘¨ï¼šè®¤è¯ä¸­é—´ä»¶å¼€å‘
- [ ] åˆ›å»ºç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶
- [ ] å®ç°JWTéªŒè¯é€»è¾‘
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

### ç¬¬2å‘¨ï¼šå¾®æœåŠ¡é›†æˆ
- [ ] æ›´æ–°user-service
- [ ] æ›´æ–°job-service
- [ ] æ›´æ–°resume-service
- [ ] æ›´æ–°company-service

### ç¬¬3å‘¨ï¼šå‰©ä½™å¾®æœåŠ¡é›†æˆ
- [ ] æ›´æ–°template-service
- [ ] æ›´æ–°banner-service
- [ ] æ›´æ–°statistics-service
- [ ] æ›´æ–°dev-team-service
- [ ] æ›´æ–°notification-service
- [ ] æ›´æ–°multi-database-service

### ç¬¬4å‘¨ï¼šæµ‹è¯•å’Œä¼˜åŒ–
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] æ–‡æ¡£æ›´æ–°
- [ ] éƒ¨ç½²éªŒè¯

## ğŸ¯ æˆåŠŸæ ‡å‡†

1. **åŠŸèƒ½æ ‡å‡†**
   - æ‰€æœ‰å¾®æœåŠ¡ä½¿ç”¨ç»Ÿä¸€çš„è®¤è¯æœºåˆ¶
   - JWTæ ¼å¼ä¸€è‡´
   - é”™è¯¯å“åº”æ ¼å¼ç»Ÿä¸€
   - æƒé™æ£€æŸ¥æ­£å¸¸å·¥ä½œ

2. **æ€§èƒ½æ ‡å‡†**
   - è®¤è¯å“åº”æ—¶é—´ < 100ms
   - ç³»ç»Ÿæ•´ä½“æ€§èƒ½ä¸ä¸‹é™
   - å†…å­˜ä½¿ç”¨åˆç†

3. **ç¨³å®šæ€§æ ‡å‡†**
   - æ‰€æœ‰å¾®æœåŠ¡æ­£å¸¸å¯åŠ¨
   - è®¤è¯å¤±è´¥æ—¶ä¼˜é›…é™çº§
   - å‘åå…¼å®¹æ€§ä¿æŒ

## ğŸ” é£é™©è¯„ä¼°

### é«˜é£é™©
- **è®¤è¯æœåŠ¡æ•…éšœ**ï¼šunified-auth-serviceä¸å¯ç”¨æ—¶çš„å½±å“
- **JWTå¯†é’¥æ³„éœ²**ï¼šå®‰å…¨é£é™©

### ä¸­é£é™©
- **æ€§èƒ½å½±å“**ï¼šé¢å¤–çš„ç½‘ç»œè°ƒç”¨
- **å…¼å®¹æ€§é—®é¢˜**ï¼šç°æœ‰å®¢æˆ·ç«¯å¯èƒ½å—å½±å“

### ä½é£é™©
- **å¼€å‘å¤æ‚åº¦**ï¼šéœ€è¦ä¿®æ”¹å¤šä¸ªæœåŠ¡
- **æµ‹è¯•å¤æ‚åº¦**ï¼šéœ€è¦æµ‹è¯•æ‰€æœ‰å¾®æœåŠ¡

## ğŸ›¡ï¸ é£é™©ç¼“è§£

1. **è®¤è¯æœåŠ¡æ•…éšœ**
   - å®ç°æœ¬åœ°JWTéªŒè¯ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
   - æ·»åŠ å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡è¯•

2. **æ€§èƒ½å½±å“**
   - å®ç°JWTç¼“å­˜æœºåˆ¶
   - ä¼˜åŒ–ç½‘ç»œè°ƒç”¨

3. **å…¼å®¹æ€§é—®é¢˜**
   - ä¿æŒAPIå‘åå…¼å®¹
   - æä¾›è¿ç§»æŒ‡å—

## ğŸ“ æ€»ç»“

è¿™ä¸ªè®¡åˆ’ä¸“æ³¨äºå¾®æœåŠ¡è®¤è¯ç»Ÿä¸€ï¼Œä¿æŒäº†basic-serverçš„ç‹¬ç«‹æ€§ï¼Œé‡‡ç”¨äº†æ¸è¿›å¼å®æ–½ç­–ç•¥ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå‘åå…¼å®¹æ€§ã€‚é€šè¿‡ç»Ÿä¸€çš„è®¤è¯ä¸­é—´ä»¶ã€æ•°æ®æ¨¡å‹å’ŒAPIæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¾®æœåŠ¡é›†ç¾¤çš„è®¤è¯ä¸€è‡´æ€§ï¼ŒåŒæ—¶ä¿æŒæ¶æ„çš„æ¸…æ™°å’Œçµæ´»æ€§ã€‚
