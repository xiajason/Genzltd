#!/bin/bash
# ç»¼åˆä»£ç å®¡è®¡å’Œæ¸…ç†è„šæœ¬
# æ‰§è¡Œå®Œæ•´çš„ä»£ç å®¡è®¡å’Œæ¸…ç†æµç¨‹

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "ðŸš€ å¼€å§‹ç»¼åˆä»£ç å®¡è®¡å’Œæ¸…ç†..."
echo "=================================="

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="/Users/szjason72/zervi-basic/basic"
SCRIPTS_DIR="$PROJECT_ROOT/scripts"

# æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$SCRIPTS_DIR/cleanup_files.sh" ]; then
    echo "âŒ æ¸…ç†è„šæœ¬ä¸å­˜åœ¨: $SCRIPTS_DIR/cleanup_files.sh"
    exit 1
fi

if [ ! -f "$SCRIPTS_DIR/code_quality_check.sh" ]; then
    echo "âŒ è´¨é‡æ£€æŸ¥è„šæœ¬ä¸å­˜åœ¨: $SCRIPTS_DIR/code_quality_check.sh"
    exit 1
fi

# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x "$SCRIPTS_DIR/cleanup_files.sh"
chmod +x "$SCRIPTS_DIR/code_quality_check.sh"

# 1. æ–‡ä»¶ç³»ç»Ÿæ¸…ç†
echo "ðŸ“ ç¬¬ä¸€é˜¶æ®µï¼šæ–‡ä»¶ç³»ç»Ÿæ¸…ç†"
echo "--------------------------------"
"$SCRIPTS_DIR/cleanup_files.sh"

echo ""
echo "â¸ï¸  æš‚åœ5ç§’ï¼Œè¯·æ£€æŸ¥æ¸…ç†ç»“æžœ..."
sleep 5

# 2. ä»£ç è´¨é‡æ£€æŸ¥
echo "ðŸ” ç¬¬äºŒé˜¶æ®µï¼šä»£ç è´¨é‡æ£€æŸ¥"
echo "--------------------------------"
"$SCRIPTS_DIR/code_quality_check.sh"

# 3. ç”Ÿæˆæ¸…ç†æ€»ç»“
echo "ðŸ“Š ç¬¬ä¸‰é˜¶æ®µï¼šç”Ÿæˆæ¸…ç†æ€»ç»“"
echo "--------------------------------"

SUMMARY_FILE="$PROJECT_ROOT/cleanup_summary.txt"
cat > "$SUMMARY_FILE" << EOF
ä»£ç å®¡è®¡å’Œæ¸…ç†æ€»ç»“æŠ¥å‘Š
================================
æ‰§è¡Œæ—¶é—´: $(date)
é¡¹ç›®è·¯å¾„: $PROJECT_ROOT

=== æ¸…ç†å†…å®¹ ===
1. æ–‡ä»¶ç³»ç»Ÿæ¸…ç†
   - åˆ é™¤å¤‡ä»½æ–‡ä»¶ (*.bak, *.backup, *.tmp, *.old)
   - æ¸…ç†æ—¥å¿—æ–‡ä»¶ (7å¤©å‰)
   - åˆ é™¤SQLiteä¸´æ—¶æ–‡ä»¶ (*.db-shm, *.db-wal)
   - æ¸…ç†é‡å¤æ•°æ®åº“æ–‡ä»¶
   - åˆ é™¤æµ‹è¯•æ®‹ç•™æ–‡ä»¶
   - æ¸…ç†æž„å»ºäº§ç‰©

2. ä»£ç è´¨é‡æ£€æŸ¥
   - æ£€æŸ¥æœªä½¿ç”¨çš„å¯¼å…¥
   - è¿è¡ŒGo linteræ£€æŸ¥
   - æ£€æŸ¥TODOæ ‡è®°
   - æ£€æŸ¥é‡å¤ä»£ç 
   - æ£€æŸ¥ä»£ç æ ¼å¼
   - æ£€æŸ¥ä¾èµ–å…³ç³»

=== æ¸…ç†ç»“æžœ ===
- é¡¹ç›®æ€»æ–‡ä»¶æ•°: $(find "$PROJECT_ROOT" -type f | wc -l)
- é¡¹ç›®æ€»å¤§å°: $(du -sh "$PROJECT_ROOT" | cut -f1)
- TODOæ ‡è®°æ•°é‡: $(grep -r "TODO\|FIXME\|XXX\|HACK" "$PROJECT_ROOT/backend" --include="*.go" | wc -l)

=== å»ºè®®åŽç»­è¡ŒåŠ¨ ===
1. è¿è¡Œ 'git status' æ£€æŸ¥æ¸…ç†ç»“æžœ
2. æäº¤æ¸…ç†åŽçš„ä»£ç 
3. å¤„ç†å‰©ä½™çš„TODOæ ‡è®°
4. ä¼˜åŒ–ä»£ç ç»“æž„
5. æ›´æ–°æ–‡æ¡£

=== æ³¨æ„äº‹é¡¹ ===
- æ¸…ç†å‰å·²å¤‡ä»½é‡è¦æ•°æ®
- å»ºè®®åœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯åŽå†åº”ç”¨åˆ°ç”Ÿäº§çŽ¯å¢ƒ
- å®šæœŸæ‰§è¡Œä»£ç å®¡è®¡å’Œæ¸…ç†
EOF

echo "ðŸ“„ æ¸…ç†æ€»ç»“å·²ç”Ÿæˆ: $SUMMARY_FILE"

# 4. æ˜¾ç¤ºGitçŠ¶æ€
echo "ðŸ“‹ æ£€æŸ¥GitçŠ¶æ€..."
cd "$PROJECT_ROOT"
if [ -d ".git" ]; then
    echo "GitçŠ¶æ€:"
    git status --short
    echo ""
    echo "å»ºè®®è¿è¡Œä»¥ä¸‹å‘½ä»¤æäº¤æ¸…ç†ç»“æžœ:"
    echo "git add ."
    echo "git commit -m 'chore: ä»£ç å®¡è®¡å’Œæ¸…ç† - åˆ é™¤å¤‡ä»½æ–‡ä»¶ã€ä¸´æ—¶æ–‡ä»¶ï¼Œä¼˜åŒ–ä»£ç è´¨é‡'"
else
    echo "âš ï¸ å½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“"
fi

echo "=================================="
echo "ðŸŽ‰ ç»¼åˆä»£ç å®¡è®¡å’Œæ¸…ç†å®Œæˆï¼"
echo ""
echo "ðŸ“‹ ä¸‹ä¸€æ­¥å»ºè®®:"
echo "1. æŸ¥çœ‹æ¸…ç†æ€»ç»“: cat $SUMMARY_FILE"
echo "2. æ£€æŸ¥GitçŠ¶æ€: git status"
echo "3. æäº¤æ¸…ç†ç»“æžœ: git add . && git commit -m 'chore: ä»£ç å®¡è®¡å’Œæ¸…ç†'"
echo "4. å¤„ç†TODOæ ‡è®°å’Œä»£ç ä¼˜åŒ–"
echo ""
echo "âœ¨ é¡¹ç›®ä»£ç è´¨é‡å·²æ˜¾è‘—æå‡ï¼"
