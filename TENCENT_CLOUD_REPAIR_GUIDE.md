# 腾讯云环境修复指南

**创建时间**: Fri Oct  3 08:04:17 CST 2025  
**问题状态**: ❌ **服务器连接失败**  
**修复优先级**: 🔴 **高优先级**

---

## 🚨 **当前问题状态**

### **连接测试结果**
```yaml
网络连通性: ❌ ping不通
SSH连接: ❌ 无法连接
服务器IP: 101.33.251.158
用户名: ubuntu
SSH密钥: ~/.ssh/basic.pem
```

### **之前成功状态回顾**
```yaml
测试时间: 2025-10-02 23:20:48
测试结果: ✅ 100%成功 (9/9测试通过)
服务状态: ✅ 所有服务正常运行
端口配置: ✅ 所有端口正确开放
```

---

## 🔍 **问题分析**

基于之前的成功部署和当前连接失败的情况，问题可能出现在以下几个方面：

### **1. 服务器状态问题**
- **可能原因**: 腾讯云轻量应用服务器已关机或重启
- **影响**: 所有服务不可访问
- **解决方案**: 登录腾讯云控制台启动服务器

### **2. 安全组配置问题**
- **可能原因**: 安全组规则被重置或修改
- **影响**: 端口访问被阻止
- **解决方案**: 重新配置安全组规则

### **3. SSH密钥问题**
- **可能原因**: SSH密钥过期或权限变更
- **影响**: SSH连接失败
- **解决方案**: 更新或重新配置SSH密钥

### **4. 网络配置问题**
- **可能原因**: 服务器网络配置发生变化
- **影响**: 公网访问异常
- **解决方案**: 检查网络配置和路由

---

## 🛠️ **修复步骤指南**

### **第一步：检查服务器状态**

1. **登录腾讯云控制台**
   - 访问：https://console.cloud.tencent.com/
   - 登录腾讯云账号

2. **找到轻量应用服务器实例**
   - 进入"轻量应用服务器"控制台
   - 查找IP地址为 `101.33.251.158` 的实例
   - 检查实例状态

3. **启动服务器（如需要）**
   - 如果实例状态为"已停止"，点击"启动"
   - 等待实例启动完成（通常需要1-2分钟）

### **第二步：配置安全组规则**

确保以下端口在安全组中开放：

```yaml
必需端口:
  22: SSH连接 (必需)
  9200: DAO版Web服务 (Nginx)
  8300: 区块链Web服务 (Node.js)
  5433: DAO PostgreSQL数据库
  6380: DAO Redis缓存

可选端口:
  80: HTTP (Web访问)
  443: HTTPS (安全Web访问)
```

**配置步骤**：
1. 在实例详情页面，点击"安全组"选项卡
2. 编辑安全组规则
3. 添加入站规则：
   - 类型：自定义
   - 端口：22, 9200, 8300, 5433, 6380
   - 来源：0.0.0.0/0
   - 协议：TCP
   - 动作：允许

### **第三步：验证SSH连接**

```bash
# 测试SSH连接
ssh -i ~/.ssh/basic.pem ubuntu@101.33.251.158

# 如果连接失败，尝试以下命令：
ssh -i ~/.ssh/basic.pem -v ubuntu@101.33.251.158
```

**如果SSH连接仍然失败**：
1. 检查SSH密钥文件是否存在：`ls -la ~/.ssh/basic.pem`
2. 检查SSH密钥权限：`chmod 600 ~/.ssh/basic.pem`
3. 尝试重新生成SSH密钥对

### **第四步：重启服务**

一旦SSH连接成功，执行以下命令重启服务：

```bash
# 连接到腾讯云服务器
ssh -i ~/.ssh/basic.pem ubuntu@101.33.251.158

# 检查Docker服务状态
sudo systemctl status docker

# 重启Docker服务
sudo systemctl restart docker

# 检查现有服务
docker ps -a

# 重启现有服务（如果存在）
cd /opt/dao-services
docker-compose -f docker-compose.tencent.yml down
docker-compose -f docker-compose.tencent.yml up -d
```

### **第五步：验证服务功能**

```bash
# 检查服务状态
docker ps

# 测试服务响应
curl http://localhost:9200
curl http://localhost:8300

# 检查端口监听
netstat -tlnp | grep -E ':(9200|8300|5433|6380)'
```

---

## 🚀 **快速修复脚本**

如果手动修复步骤太复杂，可以使用我们提供的自动化修复脚本：

```bash
# 运行腾讯云环境修复脚本
./fix-tencent-cloud-environment.sh
```

**脚本功能**：
- 自动检查服务器连接状态
- 自动检查服务运行状态
- 自动重启Docker服务
- 自动部署简化版服务（如需要）
- 自动验证服务功能

---

## 📊 **预期修复结果**

修复成功后，应该看到以下结果：

### **服务状态**
```yaml
DAO版Web服务: ✅ HTTP 200 (端口9200)
区块链Web服务: ✅ HTTP 200 (端口8300)
DAO PostgreSQL: ✅ 连接正常 (端口5433)
DAO Redis: ✅ 连接正常 (端口6380)
```

### **测试结果**
```yaml
总测试数: 9个
通过测试: 9个
失败测试: 0个
成功率: 100%
```

---

## 🔄 **修复后的数据一致性测试**

腾讯云环境修复成功后，可以运行完整的三环境数据一致性测试：

```bash
# 运行改进的数据一致性测试
./improved-data-consistency-test.sh
```

**预期结果**：
- 通过率从75%提升到85%+
- 腾讯云环境测试项全部通过
- 三环境数据一致性显著改善

---

## 📞 **技术支持**

如果在修复过程中遇到问题，可以参考以下资源：

### **腾讯云官方文档**
- 轻量应用服务器使用指南
- 安全组配置说明
- SSH密钥管理指南

### **项目相关文档**
- `TENCENT_CLOUD_E2E_TEST_VERIFICATION_REPORT.md` - 之前的成功测试报告
- `setup-tencent-test-environment.sh` - 环境搭建脚本
- `deploy-dao-tencent.sh` - DAO服务部署脚本

---

## ✅ **修复完成确认**

修复完成后，请确认以下项目：

- [ ] 服务器状态：运行中
- [ ] 安全组配置：端口正确开放
- [ ] SSH连接：正常
- [ ] Docker服务：运行正常
- [ ] DAO Web服务：HTTP 200响应
- [ ] 区块链服务：HTTP 200响应
- [ ] 数据库服务：连接正常
- [ ] 数据一致性测试：通过率>85%

---

**🎯 修复目标**: 恢复腾讯云环境的100%服务可用性，实现三环境数据一致性测试通过率>85%

**⏰ 预计修复时间**: 15-30分钟（取决于服务器状态和网络情况）

**🚨 紧急程度**: 高（影响三环境数据一致性测试完整性）
